package main

import (
    "flag"
    "fmt"
    "os"
    "strconv"

    "github.com/aws/aws-sdk-go/aws"
    "github.com/aws/aws-sdk-go/aws/session"
    "github.com/aws/aws-sdk-go/service/sqs"
)

// Creates a new SQS queue with long polling enabled. If the Queue already exists
// no error will be returned.
//
// Usage:
//    go run sqs_longpolling_create_queue.go -n queue_name -t timeout
func main() {
    namePtr := flag.String("n", "", "Queue name")
    timeoutPtr := flag.Int("t", 20, "(Optional) Timeout in seconds for long polling")

    flag.Parse()

    if *namePtr == "" {
        flag.PrintDefaults()
        exitErrorf("Queue name required")
    }

    // Initialize a session that the SDK will use to load
    // credentials from the shared credentials file. (~/.aws/credentials).
    sess := session.Must(session.NewSessionWithOptions(session.Options{
        SharedConfigState: session.SharedConfigEnable,
    }))

    svc := sqs.New(sess)

    // Create the Queue with long polling enabled
    result, err := svc.CreateQueue(&sqs.CreateQueueInput{
        QueueName: namePtr,
        Attributes: aws.StringMap(map[string]string{
            "ReceiveMessageWaitTimeSeconds": strconv.Itoa(*timeoutPtr),
        }),
    })
    if err != nil {
        exitErrorf("Unable to create queue %q, %v.", *namePtr, err)
    }

    fmt.Printf("Successfully created queue %q. URL: %s\n", *namePtr,
        aws.StringValue(result.QueueUrl))

}

func exitErrorf(msg string, args ...interface{}) {
    fmt.Fprintf(os.Stderr, msg+"\n", args...)
    os.Exit(1)
}
