<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "file://zonbook/docbookx.dtd"
[
   <!ENTITY % phrases SYSTEM "file://AWSShared/common/phrases.ent">
   %phrases;
   <!ENTITY % sig2-migration SYSTEM "file://AWSShared/asp/eu-xml/fps-sig2-migration.ent">
   %sig2-migration;
   <!ENTITY % phrases-products SYSTEM "file://AWSShared/common/aws-prod-names-and-links.ent">
   %phrases-products;
   <!ENTITY % phrases-shared-fps SYSTEM "file://AWSShared/asp/eu-xml/phrases-shared-fps.ent">
   %phrases-shared-fps;
   <!ENTITY % phrases-shared SYSTEM "file://AWSShared/common/phrases-shared.ent">
   %phrases-shared;   
   <!ENTITY % xinclude SYSTEM "file://AWSShared/common/xinclude.mod">
   %xinclude;
]>
<chapter id="VerifyingSignatureV1" role="topic">
  <title id="VerifyingSignatureV1.title">Appendix: How Responses Signed with Signature Version 1 were Verified.</title>
  <indexterm>
    <primary>signature, verifying</primary>
  </indexterm>
  <para>&SIGEXPIRENOTE;</para>
  <para>Signature version 1 is no longer supported. You must convert your signature version 1 code to signature version 2. This section is provided only as a reference for helping you to convert your code to signature version 2. For more information, see <link
      endterm="Sig2Migration.title" linkend="Sig2Migration"/></para>
  <table frame="all">
    <?dbhtml table-width="100%" ?>
    <?dbfo table-width="95%" ?>
    <title>Verifying a return signature</title>
    <tgroup cols="2">
      <colspec colname="c1" colnum="1" colwidth="0.36*"/>
      <colspec colname="c2" colnum="2" colwidth="8.64*"/>
      <tbody>
        <row>
          <entry>1</entry>
          <entry>Decrypt the request.</entry>
        </row>
        <row>
          <entry>2</entry>
          <entry>Read the AWS Access Key ID from the request. Check that it is a valid Access Key ID.</entry>
        </row>
        <row>
          <entry>3</entry>
          <entry>Use the AWS Access Key ID value to look up the value of your Secret Key.</entry>
        </row>
        <row>
          <entry>4</entry>
          <entry>Remove the signature parameter and its value from the request.</entry>
        </row>
        <row>
          <entry>5</entry>
          <entry>Use your Secret Key and the remainder of the request to compute the signature of the request. To generate a signature, see <xref condition="asp" endterm="Sig2CreateSignature.title" linkend="Sig2CreateSignature"/><xref condition="fps" endterm="APPNDX_GeneratingaSignature.title" linkend="APPNDX_GeneratingaSignature"/></entry>
        </row>
        <row>
          <entry>6</entry>
          <entry>Compare that signature with the signature in the original request.</entry>
        </row>
        <row>
          <entry>7</entry>
          <entry>
            <para>The signatures must match. If they do not, an error is returned.</para>
          </entry>
        </row>
      </tbody>
    </tgroup>
  </table>
  <para condition="asp">For more information about handling responses, see <link endterm="CapturingData.title" linkend="CapturingData"/>. This process assumes you are signing your buttons. If you choose not to sign them, you should verify that none of the parameters have been changed after the message was sent by some other means (to prevent signing, you need to clear the <guilabel >Sign the buttons?</guilabel> option in your default configuration, as explained in <link linkend="DefaultConfiguration">Configuring Your Default Button Values</link>).</para>
  
  <section id="sigv1-and-access-key-rotation" role="topic" condition="never">
    <title id="sigv1-and-access-key-rotation.title">Access Key Rotation Considerations with Signature Version 1</title>
    <para>If you enable <glossterm linkend="accesskeyrotation">access key rotation</glossterm> using signature version 1, the <glossterm linkend="outboundnotifications">outbound notifications</glossterm> will be signed according to the rules in the following table. These rules are dependant on three conditions:</para>
    <itemizedlist>
      <listitem><para>Your account has two active key pairs (referred to below as <emphasis>K1</emphasis> and <emphasis>K2</emphasis>)</para></listitem>
      <listitem><para><emphasis>K1</emphasis> was created before <emphasis>K2</emphasis>.</para></listitem>
      <listitem><para>You use <emphasis>K2</emphasis> to sign the incoming request (FPS API/CBUI pipeline/Simple Pay button request)</para></listitem>
    </itemizedlist>
    <orderedlist numeration="arabic">
      <listitem><para>The responses will be signed using <emphasis>K2</emphasis> for all the corresponding outbound notifications generated by the request.</para></listitem>
      <listitem><para>If you deactivated <emphasis>K2</emphasis> before all the outbound notifications are generated, the signatures for all pending notifications will be generated using <emphasis>K1</emphasis> (the oldest active key). For example:</para></listitem>
      <listitem>
        <orderedlist numeration="loweralpha" condition="fps">
            <listitem><para>A <function>Pay</function> request is signed using <emphasis>K2</emphasis>.</para></listitem>
            <listitem><para>The <parameter>Payment Initiated</parameter> IPN is signed using <emphasis>K2</emphasis> and sent to the specified IPN endpoint.</para></listitem>
            <listitem><para><emphasis>K2</emphasis> is deactivated or deleted and a new key, <emphasis>K3</emphasis>, is created.</para></listitem>
            <listitem><para>The <parameter>Payment Successful</parameter> IPN is signed using <emphasis>K1</emphasis> and sent to the specified IPN endpoint.</para></listitem>
        </orderedlist>
        <orderedlist numeration="loweralpha" condition="asp">
            <listitem><para>An &asp_product; Standard Button is signed using <emphasis>K2</emphasis>.</para></listitem>
            <listitem><para>The data sent to the success return URL is signed using <emphasis>K2</emphasis>.</para></listitem>
            <listitem><para><emphasis>K2</emphasis> is deactivated or deleted and a new key, <emphasis>K3</emphasis>, is created.</para></listitem>
            <listitem><para>The <parameter>Payment Successful</parameter> IPN is signed using <emphasis>K1</emphasis> and sent to the specified IPN endpoint.</para></listitem>      
        </orderedlist>
      </listitem>
      <listitem><para>If all the keys are deactivated or deleted before the outbound notification is generated, we send the notification without any signature.</para></listitem>
    </orderedlist>
    <para>For information about <glossterm linkend="accesskeyrotation">access key rotation</glossterm>, see <link linkend="access-key-rotation" endterm="access-key-rotation.title"/>. </para>
  </section>
  
</chapter>
